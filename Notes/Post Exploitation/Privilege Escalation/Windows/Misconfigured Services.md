# Introduction
Windows Services allow for the creation of continuously running executable applications. These applications have the ability to be automatically started upon booting, they may be paused and restarted, and they lack a user interface. 

In order for a service to function properly, it needs to be associated with a system or user account. There are a few common built-in system accounts that are used to operate services such as `LocalService`, `NetworkService`, and `LocalSystem`. The following table describe the default secure access rights for accounts on a Windows system:

|Account|Permissions|
|-------|:-----------:|
|Local Authenticated Users <br /> (including `LocalService` and `Network Service`)|`READ_CONTROL`<br /> `SERVICE_ENUMERATE DEPENDENTS` <br /> `SERVICE_INTERROGATE` <br /> `SERVICE_QUERY_CONFIG` <br /> `SERVICE_QUERY_STATUS` <br /> `SERVICE_USER_DEFINED_CONTROL`|
|Remote Authenticated Users | Same as those for Local Authenitcated Users. |
|`LocalSystem`|`READ_CONTROL` <br /> `SERVICE_ENUMERATE DEPENDENTS` <br /> `SERVICE_INTERROGATE` <br /> `SERVICE_PAUSE_CONTINUE` <br /> `SERVICE_QUERY_CONFIG` <br /> `SERVICE_QUERY_STATUS` <br /> `SERVICE_START` <br /> `SERVICE_STOP` <br /> `SERVICE_USER_DEFINED_CONTROL`|
|Administrators|`DELETE` <br /> `READ_CONTROL` <br /> `SERVICE_ALL_ACCESS` <br /> `WRITE_DAC` <br /> `WRITE_OWNER`|

### Enumeration
In general, manual enumeration of Windows services is a rather cumbersome process, so I suggest that you use a tool for automation such as [WinPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS).

```powershell
winpeas.exe servicesinfo
```

![](Resources/Images/Misconfigured%20Services/WinPEAS%20Enumerate%20Services.png)

# Insecure Service Permissions
This is a technique which leverages misconfigurations in the service permissions for a specific user. If permissions for a specific user differ from the ones above, then they may manifest as a possible vulnerability.

To identify such services, it is useful to use WinPEAS as mentioned above.
![](Resources/Images/Misconfigured%20Services/WinPEAS%20daclsvc.png)

The permissions a user has on a specific service can be inspected via the [AccessChk](https://learn.microsoft.com/en-us/sysinternals/downloads/accesschk) Windows Utility. 

```powershell
acceschk.exe /accepteula -uwcqv <account> <service> 
```

![](Resources/Images/Misconfigured%20Services/Access%20Check%20Permissions.png)

It appears that `user` has write access to the service `daclsvc` and can also start the service.  We can query the service to see what user account is actually executing it:

```powershell
sc qc <service>
```

![](Resources/Images/Misconfigured%20Services/Query%20Service.png)

It appears that the service is running as `LocalSystem` which is an account with more privileges than our `user` account. If we can write to the service, then we can alter its configuration and change the path to the executable which is supposed to be run:

```powershell
sc config <service> binpath="\"<path>\""
```

![](Resources/Images/Misconfigured%20Services/Change%20Config.png)

All we now need to do is setup a listener and run the service:
```powershell
net start <service>
```

And we get a system shell back:

![](Resources/Images/Misconfigured%20Services/Shell.png)

# Unquoted Service Paths
This is a vulnerability which can be used to force a misconfigured service to execute an arbitrary programme in lieu of its intended one, as long as the path to that executable contains spaces. On its own, this does not allow for privilege escalation, but it becomes a really powerful tool when the misconfigured service is set to run with system privileges.

Let's take a look at the following path:
```
C:\Program Files\Vulnerable Service\service.exe
```

If this path was specified to the service in quotation marks, `"C:\Program Files\Vulnerable Service\service.exe"`, then Windows will treat it correctly, executing the `service.exe` file in the `C:\Program Files\Vulnerable Service` directory.

However, Windows is not the sharpest tool in the box and if the path is provided without quotation marks, then it will see ambiguity in what it is supposed to execute. The path will be split at each space character - the first segment will be treated as the executable's name and the rest will be seen as command-line arguments to be passed to it. So at first, Windows will try to execute the following:
```powershell
C:\Program.exe Files\Vulnerable Service\service.exe
```

Once Windows determines that the `C:\Program.exe` file does not exist, it will look for the next space character, treat the characters up to it as the new path and try to execute it again:
```powershell
C:\Program Files\Vulnerable.exe Service\service.exe
```

Now, this is process is recursive until a file is successfully executed or the end of the path has been reached. If we are able to create a malicious executable in any of the possible paths that Windows will attempt to execute, then we can hijack the service before the intended file is found.

Once you have identified a vulnerable service, you can query to confirm that the path is indeed in unquoted.

![](Resources/Images/Misconfigured%20Services/Unquoted%20Service%20Path.png)

![](Resources/Images/Misconfigured%20Services/Query%20unquotedsvc.png)

Let's check our access to the possible directories that will be probed by Windows:
```powershell
accesschk.exe /accepteula -uwdq <directory>
```

![](Resources/Images/Misconfigured%20Services/Check%20Directory%20Permissions.png)

While we cannot write within the `C:\` or `C:\Program Files` directories (meaning that we cannot create `C:\Program.exe` or `C:\Program Files\Unquoted.exe`), we do have write access to `C:\Program Files\Unquoted Path Service\`. What this entails is our ability to create a `Common.exe` binary inside this directory and, since the initial path was unquoted, the path `C:\Program Files\Unquoted Path Service\Common.exe` will be probed before `C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe` and once Windows finds our malicious executable there, it will be executed with the service's permissions.

![](Resources/Images/Misconfigured%20Services/Copy%20To%20Unquoted%20Path.png)

If we couldn't restart the service, then we could have simply waited for something else to execute it.

![](Resources/Images/Misconfigured%20Services/Shell.png)
