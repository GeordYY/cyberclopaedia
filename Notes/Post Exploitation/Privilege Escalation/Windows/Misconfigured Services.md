# Introduction
Windows Services allow for the creation of continuously running executable applications. These applications have the ability to be automatically started upon booting, they may be paused and restarted, and they lack a user interface. 

In order for a service to function properly, it needs to be associated with a system or user account. There are a few common built-in system accounts that are used to operate services such as `LocalService`, `NetworkService`, and `LocalSystem`. The following table describe the default secure access rights for accounts on a Windows system:

|Account|Permissions|
|-------|:-----------:|
|Local Authenticated Users <br /> (including `LocalService` and `Network Service`)|`READ_CONTROL`<br /> `SERVICE_ENUMERATE DEPENDENTS` <br /> `SERVICE_INTERROGATE` <br /> `SERVICE_QUERY_CONFIG` <br /> `SERVICE_QUERY_STATUS` <br /> `SERVICE_USER_DEFINED_CONTROL`|
|Remote Authenticated Users | Same as those for Local Authenitcated Users. |
|`LocalSystem`|`READ_CONTROL` <br /> `SERVICE_ENUMERATE DEPENDENTS` <br /> `SERVICE_INTERROGATE` <br /> `SERVICE_PAUSE_CONTINUE` <br /> `SERVICE_QUERY_CONFIG` <br /> `SERVICE_QUERY_STATUS` <br /> `SERVICE_START` <br /> `SERVICE_STOP` <br /> `SERVICE_USER_DEFINED_CONTROL`|
|Administrators|`DELETE` <br /> `READ_CONTROL` <br /> `SERVICE_ALL_ACCESS` <br /> `WRITE_DAC` <br /> `WRITE_OWNER`|

### Enumeration
In general, manual enumeration of Windows services is a rather cumbersome process, so I suggest that you use a tool for automation such as [WinPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS).

```powershell
winpeas.exe servicesinfo
```

![](Resources/Images/Misconfigured%20Services/WinPEAS%20Enumerate%20Services.png)

# Insecure Service Permissions
This is a technique which leverages misconfigurations in the service permissions for a specific user. If permissions for a specific user differ from the ones above, then they may manifest as a possible vulnerability.

To identify such services, it is useful to use WinPEAS as mentioned above.
![](Resources/Images/Misconfigured%20Services/WinPEAS%20daclsvc.png)

The permissions a user has on a specific service can be inspected via the [AccessChk](https://learn.microsoft.com/en-us/sysinternals/downloads/accesschk) Windows Utility. 

```powershell
acceschk.exe /accepteula -uwcqv <account> <service> 
```

![](Resources/Images/Misconfigured%20Services/Access%20Check%20Permissions.png)

It appears that `user` has write access to the service `daclsvc` and can also start the service.  We can query the service to see what user account is actually executing it:

```powershell
sc qc <service>
```

![](Resources/Images/Misconfigured%20Services/Query%20Service.png)

It appears that the service is running as `LocalSystem` which is an account with more privileges than our `user` account. If we can write to the service, then we can alter its configuration and change the path to the executable which is supposed to be run:

```powershell
sc config <service> binpath="\"<path>\""
```

![](Resources/Images/Misconfigured%20Services/Change%20Config.png)

All we now need to do is setup a listener and run the service:
```
net start <service>
```

And we get a system shell back:

![](Resources/Images/Misconfigured%20Services/System%20Shell.png)